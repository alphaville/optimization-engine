<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="X-UA-Compatible" content="IE=edge"/><title>Husky robot with ROS · OpEn</title><meta name="viewport" content="width=device-width, initial-scale=1.0"/><meta name="generator" content="Docusaurus"/><meta name="description" content="Nonlinear model predictive control with OpEn using ROS"/><meta name="docsearch:language" content="en"/><meta property="og:title" content="Husky robot with ROS · OpEn"/><meta property="og:type" content="website"/><meta property="og:url" content="https://alphaville.github.io/optimization-engine/"/><meta property="og:description" content="Nonlinear model predictive control with OpEn using ROS"/><meta property="og:image" content="https://alphaville.github.io/optimization-engine/img/docusaurus2.svg"/><meta name="twitter:card" content="summary"/><meta name="twitter:image" content="https://alphaville.github.io/optimization-engine/img/docusaurus.png"/><link rel="shortcut icon" href="/optimization-engine/img/box.png"/><link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/default.min.css"/><link rel="alternate" type="application/atom+xml" href="https://alphaville.github.io/optimization-engine/blog/atom.xml" title="OpEn Blog ATOM Feed"/><link rel="alternate" type="application/rss+xml" href="https://alphaville.github.io/optimization-engine/blog/feed.xml" title="OpEn Blog RSS Feed"/><script type="text/javascript" src="https://buttons.github.io/buttons.js"></script><script src="/optimization-engine/js/scrollSpy.js"></script><link rel="stylesheet" href="/optimization-engine/css/main.css"/><script src="/optimization-engine/js/codetabs.js"></script></head><body class="sideNavVisible separateOnPageNav"><div class="fixedHeaderContainer"><div class="headerWrapper wrapper"><header><a href="/optimization-engine/"><img class="logo" src="/optimization-engine/img/box.png" alt="OpEn"/><h2 class="headerTitleWithLogo">OpEn</h2></a><div class="navigationWrapper navigationSlider"><nav class="slidingNav"><ul class="nav-site nav-site-internal"><li class=""><a href="/optimization-engine/docs/open-intro" target="_self">Docs</a></li><li class=""><a href="/optimization-engine/blog/" target="_self">Blog</a></li><li class=""><a href="https://docs.rs/optimization_engine/*/optimization_engine/" target="_self">API</a></li><li class=""><a href="/optimization-engine/blog/2019/03/06/talk-to-us" target="_self">Chat</a></li><li class=""><a href="https://www.github.com/alphaville/optimization-engine" target="_self">Github</a></li></ul></nav></div></header></div></div><div class="navPusher"><div class="docMainWrapper wrapper"><div class="docsNavContainer" id="docsNav"><nav class="toc"><div class="toggleNav"><section class="navWrapper wrapper"><div class="navBreadcrumb wrapper"><div class="navToggle" id="navToggler"><div class="hamburger-menu"><div class="line1"></div><div class="line2"></div><div class="line3"></div></div></div><h2><i>›</i><span>Python</span></h2><div class="tocToggler" id="tocToggler"><i class="icon-toc"></i></div></div><div class="navGroups"><div class="navGroup"><h3 class="navGroupCategoryTitle collapsible">Python<span class="arrow"><svg width="24" height="24" viewBox="0 0 24 24"><path fill="#565656" d="M7.41 15.41L12 10.83l4.59 4.58L18 14l-6-6-6 6z"></path><path d="M0 0h24v24H0z" fill="none"></path></svg></span></h3><ul class="hide"><li class="navListItem"><a class="navItem" href="/optimization-engine/docs/example_rosenbrock_py">Rosenbrock Function</a></li><li class="navListItem"><a class="navItem" href="/optimization-engine/docs/example_navigation_py">Navigation of ground vehicle</a></li><li class="navListItem"><a class="navItem" href="/optimization-engine/docs/example_estimation_py">Nonlinear State Estimation</a></li><li class="navListItem"><a class="navItem" href="/optimization-engine/docs/example_bnp_py">Ball and Plate</a></li><li class="navListItem"><a class="navItem" href="/optimization-engine/docs/example_tanks_py">Tandem tanks</a></li><li class="navListItem"><a class="navItem" href="/optimization-engine/docs/example_invpend_py">Inverted Pendulum</a></li><li class="navListItem navListItemActive"><a class="navItem" href="/optimization-engine/docs/example_navigation_ros_codegen">Husky robot with ROS</a></li></ul></div></div></section></div><script>
            var coll = document.getElementsByClassName('collapsible');
            var checkActiveCategory = true;
            for (var i = 0; i < coll.length; i++) {
              var links = coll[i].nextElementSibling.getElementsByTagName('*');
              if (checkActiveCategory){
                for (var j = 0; j < links.length; j++) {
                  if (links[j].classList.contains('navListItemActive')){
                    coll[i].nextElementSibling.classList.toggle('hide');
                    coll[i].childNodes[1].classList.toggle('rotate');
                    checkActiveCategory = false;
                    break;
                  }
                }
              }

              coll[i].addEventListener('click', function() {
                var arrow = this.childNodes[1];
                arrow.classList.toggle('rotate');
                var content = this.nextElementSibling;
                content.classList.toggle('hide');
              });
            }

            document.addEventListener('DOMContentLoaded', function() {
              createToggler('#navToggler', '#docsNav', 'docsSliderActive');
              createToggler('#tocToggler', 'body', 'tocActive');

              var headings = document.querySelector('.toc-headings');
              headings && headings.addEventListener('click', function(event) {
                var el = event.target;
                while(el !== headings){
                  if (el.tagName === 'A') {
                    document.body.classList.remove('tocActive');
                    break;
                  } else{
                    el = el.parentNode;
                  }
                }
              }, false);

              function createToggler(togglerSelector, targetSelector, className) {
                var toggler = document.querySelector(togglerSelector);
                var target = document.querySelector(targetSelector);

                if (!toggler) {
                  return;
                }

                toggler.onclick = function(event) {
                  event.preventDefault();

                  target.classList.toggle(className);
                };
              }
            });
        </script></nav></div><div class="container mainContainer docsContainer"><div class="wrapper"><div class="post"><header class="postHeader"><h1 id="__docusaurus" class="postHeaderTitle">Husky robot with ROS</h1></header><article><div><span><script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});</script>
<script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<style>
.but{
  border: none;
  color: white;
  padding: 15px 20px;
  text-align: center;
  text-decoration: none;
  display: inline-block;
  font-size: 16px;
  margin: 0px 0px;
  cursor: pointer;
  width: 250px;
  border-radius: 8px;
}
</style>
<style>
.but1 {
    background-color: #4CAF50;
}
</style><style>
.but2 {
    background-color: #008CBA;
}
</style>
<p><a href="https://github.com/gmsanchez/open_ros_codegen" target="_blank"><button class="but but1" >See Complete Project</button></a> <a href="python-examples"><button class="but but2" >Back to Examples</button></a></p>
<p>Example contributed by Guido Sanchez (<a href="https://github.com/gmsanchez/">Github</a>)</p>
<h2><a class="anchor" aria-hidden="true" id="auto-generated-ground-vehicle-navigation-for-ros"></a><a href="#auto-generated-ground-vehicle-navigation-for-ros" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Auto-generated ground vehicle navigation for ROS</h2>
<p>We will create a MPC controller for position tracking of a <a href="https://clearpathrobotics.com/husky-unmanned-ground-vehicle-robot/">Husky</a> ground vehicle. Husky is a medium sized robotic development platform fully supported in ROS with community driven Open Source code and examples.</p>
<p><img src="/optimization-engine/img/husky.jpg" alt="Husky Ground Vehicle"></p>
<p>The vehicle can be modeled using the differential drive equations:</p>
<div class="math">
\[\begin{split}
\dot{x}(t) {}={}&amp; v(t) \cos \theta(t),\\
\dot{y}(t) {}={}&amp; v(t) \sin \theta(t),\\
\dot{\theta}(t) {}={}&amp; \omega(t).
\end{split}\]
</div>
<p>We want to solve the following optimal control problem</p>
<div class="math">
\[
    \begin{align}
    \mathbb{P}(z){}:{}\operatorname*{Minimize}_{u_0, \ldots, u_{N-1}}& \sum_{i=1}^{N - 1} 
        \|x_t-x^{\mathrm{ref}}\|_Q^2 + \|u_t\|_R^2 + \|x_N-x^{\mathrm{ref}}\|_{Q_N}^2
    \\
    \text{subject to: }& x_{t+1} = f(x_t, u_t), t=0,\ldots, N-1
    \\
    &u_{\min} \leq u_t \leq u_{\max}, t=0,\ldots, N-1
    \\
    &x_0=z
    \end{align}
\]</div>
<p>where $x = (p_x,p_y,\theta)$ is the position and orientation of the vehicle,
$x^{\mathrm{ref}}$ is the target position and orientation, $u = (v, \omega)$ is the linear and angular velocity of the vehicle and $f$ describes
the vehicle dynamics, which in this example is</p>
<div class="math">
\[
    f(x, u) = \begin{bmatrix}
    p_x + t_s (v \cos\theta)
    \\
    p_y + t_s (v \sin\theta )
    \\
    \theta + t_s \omega
    \end{bmatrix}
\]</div>
<p>The auto generated controller will allow you to move the vehicle to any point of the simulation grid, as shown in the following video</p>
<video width="672" height="378" controls>
  <source src="/optimization-engine/img/husky_video.mp4" type="video/mp4">
</video>
<h3><a class="anchor" aria-hidden="true" id="code-generation-for-the-mpc-controller"></a><a href="#code-generation-for-the-mpc-controller" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Code generation for the MPC controller</h3>
<p>To generate a ROS package you can use opengen - OpEn's Python interface (with opengen version <code>0.5.0</code> or newer). You will have to provide certain configuration parameters, such as the package name, the node name and the rate of your node in Hz.</p>
<h3><a class="anchor" aria-hidden="true" id="install-opengen-050-in-a-virtual-environment"></a><a href="#install-opengen-050-in-a-virtual-environment" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Install opengen 0.5.0 in a virtual environment</h3>
<pre><code class="hljs css language-bash"><span class="hljs-built_in">cd</span> ~
mkdir ~/open_ros_codegen
<span class="hljs-built_in">cd</span> ~/open_ros_codegen
virtualenv -p python3.6 venvopen
<span class="hljs-built_in">source</span> venvopen/bin/activate
pip install opengen==0.5.0
pip install matplotlib
</code></pre>
<h3><a class="anchor" aria-hidden="true" id="run-the-example-code-generation-program"></a><a href="#run-the-example-code-generation-program" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Run the example code generation program</h3>
<p>Let's make a folder for the code generation script</p>
<pre><code class="hljs css language-bash">mkdir -p ~/open_ros_codegen/nmpc_open
<span class="hljs-built_in">cd</span> ~/open_ros_codegen/nmpc_open
</code></pre>
<p>Create a file named <code>create_open_solver.py</code> inside the <code>nmpc_open</code> folder with the following content</p>
<pre><code class="hljs css language-python"><span class="hljs-keyword">import</span> casadi <span class="hljs-keyword">as</span> cs
<span class="hljs-keyword">import</span> opengen <span class="hljs-keyword">as</span> og
<span class="hljs-keyword">import</span> numpy <span class="hljs-keyword">as</span> np

N = <span class="hljs-number">10</span>  <span class="hljs-comment"># The MPC horizon length</span>
NX = <span class="hljs-number">3</span>  <span class="hljs-comment"># The number of elements in the state vector</span>
NU = <span class="hljs-number">2</span>  <span class="hljs-comment"># The number of elements in the control vector</span>
sampling_time = <span class="hljs-number">0.1</span>
NSim = <span class="hljs-number">100</span>

Q = cs.DM.eye(NX) * [<span class="hljs-number">1.0</span>, <span class="hljs-number">1.0</span>, <span class="hljs-number">0.0001</span>]
R = cs.DM.eye(NU) * [<span class="hljs-number">0.1</span>, <span class="hljs-number">50.0</span>]
QN = cs.DM.eye(NX) * [<span class="hljs-number">10.0</span>, <span class="hljs-number">10.0</span>, <span class="hljs-number">0.0001</span>]


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dynamics_ct</span><span class="hljs-params">(_x, _u)</span>:</span>
    <span class="hljs-keyword">return</span> cs.vcat([_u[<span class="hljs-number">0</span>] * cs.cos(_x[<span class="hljs-number">2</span>]),
                    _u[<span class="hljs-number">0</span>] * cs.sin(_x[<span class="hljs-number">2</span>]),
                    _u[<span class="hljs-number">1</span>]])


<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">dynamics_dt</span><span class="hljs-params">(x, u)</span>:</span>
    dx = dynamics_ct(x, u)
    <span class="hljs-keyword">return</span> cs.vcat([x[i] + sampling_time * dx[i] <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(NX)])


<span class="hljs-comment"># The stage cost for x and u</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">stage_cost</span><span class="hljs-params">(_x, _u, _x_ref=None, _u_ref=None)</span>:</span>
    <span class="hljs-keyword">if</span> _x_ref <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        _x_ref = cs.DM.zeros(_x.shape)
    <span class="hljs-keyword">if</span> _u_ref <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        _u_ref = cs.DM.zeros(_u.shape)
    dx = _x - _x_ref
    du = _u - _u_ref
    <span class="hljs-keyword">return</span> cs.mtimes([dx.T, Q, dx]) + cs.mtimes([du.T, R, du])


<span class="hljs-comment"># The terminal cost for x</span>
<span class="hljs-function"><span class="hljs-keyword">def</span> <span class="hljs-title">terminal_cost</span><span class="hljs-params">(_x, _x_ref=None)</span>:</span>
    <span class="hljs-keyword">if</span> _x_ref <span class="hljs-keyword">is</span> <span class="hljs-literal">None</span>:
        _x_ref = cs.DM.zeros(_x.shape)
    dx = _x - _x_ref
    <span class="hljs-keyword">return</span> cs.mtimes([dx.T, QN, dx])


x_0 = cs.MX.sym(<span class="hljs-string">"x_0"</span>, NX)
x_ref = cs.MX.sym(<span class="hljs-string">"x_ref"</span>, NX)
u_k = [cs.MX.sym(<span class="hljs-string">'u_'</span> + str(i), NU) <span class="hljs-keyword">for</span> i <span class="hljs-keyword">in</span> range(N)]

<span class="hljs-comment"># Create the cost function</span>
x_t = x_0
total_cost = <span class="hljs-number">0</span>

<span class="hljs-keyword">for</span> t <span class="hljs-keyword">in</span> range(<span class="hljs-number">0</span>, N):
    total_cost += stage_cost(x_t, u_k[t], x_ref)  <span class="hljs-comment"># update cost</span>
    x_t = dynamics_dt(x_t, u_k[t])  <span class="hljs-comment"># update state</span>

total_cost += terminal_cost(x_t, x_ref)  <span class="hljs-comment"># terminal cost</span>

optimization_variables = []
optimization_parameters = []

optimization_variables += u_k
optimization_parameters += [x_0]
optimization_parameters += [x_ref]

optimization_variables = cs.vertcat(*optimization_variables)
optimization_parameters = cs.vertcat(*optimization_parameters)

umin = [<span class="hljs-number">-2.0</span>, <span class="hljs-number">-1.0</span>] * N  <span class="hljs-comment"># - cs.DM.ones(NU * N) * cs.inf</span>
umax = [<span class="hljs-number">2.0</span>, <span class="hljs-number">1.0</span>] * N  <span class="hljs-comment"># cs.DM.ones(NU * N) * cs.inf</span>

bounds = og.constraints.Rectangle(umin, umax)

problem = og.builder.Problem(optimization_variables,
                             optimization_parameters,
                             total_cost) \
    .with_constraints(bounds)

ros_config = og.config.RosConfiguration() \
    .with_package_name(<span class="hljs-string">"open_nmpc_controller"</span>) \
    .with_node_name(<span class="hljs-string">"open_mpc_controller_node"</span>) \
    .with_rate((int)(<span class="hljs-number">1.0</span>/sampling_time)) \
    .with_description(<span class="hljs-string">"Cool ROS node."</span>)

build_config = og.config.BuildConfiguration()\
    .with_build_directory(<span class="hljs-string">"optimization_engine"</span>)\
    .with_build_mode(<span class="hljs-string">"release"</span>)\
    .with_build_c_bindings() \
    .with_ros(ros_config)

meta = og.config.OptimizerMeta()\
    .with_optimizer_name(<span class="hljs-string">"mpc_controller"</span>)

solver_config = og.config.SolverConfiguration()\
    .with_tolerance(<span class="hljs-number">1e-5</span>)

builder = og.builder.OpEnOptimizerBuilder(problem,
                                          meta,
                                          build_config,
                                          solver_config)
builder.build()
</code></pre>
<p>The above program will generate a parametric optimizer at <code>optimization_engine/mpc_controller</code>. The ROS package will be in <code>optimization_engine/mpc_controller/open_nmpc_controller</code>.</p>
<h2><a class="anchor" aria-hidden="true" id="create-a-ros-workspace-for-our-new-package"></a><a href="#create-a-ros-workspace-for-our-new-package" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Create a ROS workspace for our new package</h2>
<p>We must create a ROS catkin workspace and place our package inside the <code>src</code> folder. We will do this by creating a symbolic link. After that, we can build and test our package.</p>
<pre><code class="hljs css language-bash">mkdir -p ~/open_ros_codegen/catkin_ws/src
<span class="hljs-built_in">cd</span> ~/open_ros_codegen/catkin_ws/src
ln -s ~/open_ros_codegen/nmpc_open/optimization_engine/mpc_controller/open_nmpc_controller .
<span class="hljs-built_in">cd</span> ~/open_ros_codegen/catkin_ws
catkin build
<span class="hljs-built_in">source</span> ~/open_ros_codegen/catkin_ws/devel/setup.bash
roslaunch open_nmpc_controller open_optimizer.launch
</code></pre>
<p>Right now we have a running ROS node with the defualt configuration. Now we must edit it a little bit to drive our vehicle.</p>
<h2><a class="anchor" aria-hidden="true" id="download-and-run-husky-packages"></a><a href="#download-and-run-husky-packages" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Download and run Husky packages</h2>
<pre><code class="hljs css language-bash"><span class="hljs-built_in">cd</span> ~/open_ros_codegen/catkin_ws/src
git <span class="hljs-built_in">clone</span> https://github.com/husky/husky.git
catkin build
</code></pre>
<p>Now we can run the Husky simulation as follows</p>
<p><code>roslaunch husky_gazebo husky_empty_world.launch</code></p>
<h2><a class="anchor" aria-hidden="true" id="edit-the-auto-generated-node"></a><a href="#edit-the-auto-generated-node" aria-hidden="true" class="hash-link"><svg class="hash-link-icon" aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Edit the auto-generated node</h2>
<p>The auto generated ROS package (as stated in the <a href="https://alphaville.github.io/optimization-engine/docs/python-ros">documentation</a>) creates two topics:</p>
<ol>
<li>A topic that waits for the input parameters of the optimizer.</li>
<li>A topic that outputs the result given the input parameters.</li>
</ol>
<p>We need to modify this behavior in order to drive the vehicle from one point to another. Our node should know where the vehicle is in order to obtain the correct control commands, so we must listen to the topic <code>/odometry/filtered</code>. This topic is already configured in the Husky package and publishes the vehicle <a href="http://docs.ros.org/melodic/api/nav_msgs/html/msg/Odometry.html">Odometry</a> data: position and orientation in 3D.</p>
<p>Given our current position and orientation, we will obtain the NMPC solution and publish it as a <a href="http://docs.ros.org/melodic/api/geometry_msgs/html/msg/Twist.html">Twist</a> message to the <code>/husky_velocity_controller/cmd_vel</code> topic. Once again, the topic is already configured in the Husky package, we just need to publish the desired velocity commands.</p>
<p>Finally, we will add a subscriber that listens on the <code>/open_nmpc_controller/command/pose</code> topic and expects a <a href="http://docs.ros.org/melodic/api/geometry_msgs/html/msg/PoseStamped.html">PoseStamped</a> message. We will use the <code>position.x</code> and <code>position.y</code> fields for the x-y reference and the <code>orientation.w</code> for the yaw angle reference (in degrees).</p>
<p>In order to accomplish that, we must modify the auto generated <code>open_optimizer.cpp</code> file. We need to add a subscriber that listens to the <code>odometry/filtered</code> topic and a publisher that publishes data to the <code>/husky_velocity_controller/cmd_vel</code> topic. The following code is a modification of the auto generated code that adds the needed functionality.</p>
<pre><code class="hljs css language-c++"><span class="hljs-comment">/**
 * This is an auto-generated file by Optimization Engine (OpEn)
 * OpEn is a free open-source software - see doc.optimization-engine.xyz
 * dually licensed under the MIT and Apache v2 licences.
 *
 * Generated at 2020-05-07 01:22:27.483106.
 */</span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"ros/ros.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"open_nmpc_controller/OptimizationResult.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"open_nmpc_controller/OptimizationParameters.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"mpc_controller_bindings.hpp"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"open_optimizer.hpp"</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;geometry_msgs/Twist.h&gt;</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">&lt;nav_msgs/Odometry.h&gt;</span></span>

<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"tf/transform_datatypes.h"</span></span>
<span class="hljs-meta">#<span class="hljs-meta-keyword">include</span> <span class="hljs-meta-string">"tf/LinearMath/Matrix3x3.h"</span></span>


<span class="hljs-keyword">namespace</span> open_nmpc_controller {
<span class="hljs-comment">/**
 * Class open_nmpc_controller::OptimizationEngineManager manages the
 * exchange of data between the input and output topics
 * of this node
 */</span>
<span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">OptimizationEngineManager</span> {</span>

<span class="hljs-keyword">private</span>:
    open_nmpc_controller::OptimizationParameters params;
    open_nmpc_controller::OptimizationResult results;
    <span class="hljs-keyword">double</span> p[MPC_CONTROLLER_NUM_PARAMETERS] = { <span class="hljs-number">0</span> };
    <span class="hljs-keyword">double</span> u[MPC_CONTROLLER_NUM_DECISION_VARIABLES] = { <span class="hljs-number">0</span> };
    <span class="hljs-keyword">double</span> *y = <span class="hljs-literal">NULL</span>;
    
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> NX = <span class="hljs-number">3</span>;
    <span class="hljs-keyword">static</span> <span class="hljs-keyword">const</span> <span class="hljs-keyword">int</span> NU = <span class="hljs-number">2</span>;
    
    <span class="hljs-keyword">double</span> current_pos[NX] = {<span class="hljs-number">0</span>};
    <span class="hljs-keyword">double</span> current_ref[NX] = {<span class="hljs-number">0</span>};

    mpc_controllerCache* cache;
    <span class="hljs-keyword">double</span> init_penalty = ROS_NODE_MPC_CONTROLLER_DEFAULT_INITIAL_PENALTY;

    <span class="hljs-comment">/**
     * Publish obtained results to output topic
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">publishToTopic</span><span class="hljs-params">(ros::Publisher&amp; publisher)</span>
    </span>{
        publisher.publish(results);
    }

    <span class="hljs-comment">/**
     * Updates the input data based on the data that are posted
     * on /mpc/open_parameters (copies value from topic data to
     * local variables). This method is responsible for parsing
     * the data announced on the input topic.
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">updateInputData</span><span class="hljs-params">()</span>
    </span>{
        init_penalty = (params.initial_penalty &gt; <span class="hljs-number">1.0</span>)
            ? params.initial_penalty
            : ROS_NODE_MPC_CONTROLLER_DEFAULT_INITIAL_PENALTY;

        <span class="hljs-keyword">if</span> (params.parameter.<span class="hljs-built_in">size</span>() &gt; <span class="hljs-number">0</span>) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; MPC_CONTROLLER_NUM_PARAMETERS; ++i)
                p[i] = params.parameter[i];
        }

        <span class="hljs-keyword">if</span> (params.initial_guess.<span class="hljs-built_in">size</span>() == MPC_CONTROLLER_NUM_DECISION_VARIABLES) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; MPC_CONTROLLER_NUM_DECISION_VARIABLES; ++i)
                u[i] = params.initial_guess[i];
        }

        <span class="hljs-keyword">if</span> (params.initial_y.<span class="hljs-built_in">size</span>() == MPC_CONTROLLER_N1) {
            <span class="hljs-keyword">for</span> (<span class="hljs-keyword">size_t</span> i = <span class="hljs-number">0</span>; i &lt; MPC_CONTROLLER_N1; ++i)
                y[i] = params.initial_y[i];
        }

    }

    <span class="hljs-comment">/**
     * Call OpEn to solve the problem
     */</span>
    <span class="hljs-function">mpc_controllerSolverStatus <span class="hljs-title">solve</span><span class="hljs-params">()</span>
    </span>{
        <span class="hljs-keyword">return</span> mpc_controller_solve(cache, u, p, y, &amp;init_penalty);
    }


<span class="hljs-keyword">public</span>:
    <span class="hljs-comment">/**
     * Constructor of OptimizationEngineManager
     */</span>
    OptimizationEngineManager()
    {
        y = <span class="hljs-keyword">new</span> <span class="hljs-keyword">double</span>[MPC_CONTROLLER_N1];
        cache = mpc_controller_new();
    }

    <span class="hljs-comment">/**
     * Destructor of OptimizationEngineManager
     */</span>
    ~OptimizationEngineManager()
    {
        <span class="hljs-keyword">if</span> (y!=<span class="hljs-literal">NULL</span>) <span class="hljs-keyword">delete</span>[] y;
        mpc_controller_free(cache);
    }

    <span class="hljs-comment">/**
     * Copies results from `status` to the local field `results`
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">updateResults</span><span class="hljs-params">(mpc_controllerSolverStatus&amp; status)</span>
    </span>{
        <span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">double</span>&gt; <span class="hljs-title">sol</span><span class="hljs-params">(u, u + MPC_CONTROLLER_NUM_DECISION_VARIABLES)</span></span>;
        results.solution = sol;
        <span class="hljs-function"><span class="hljs-built_in">std</span>::<span class="hljs-built_in">vector</span>&lt;<span class="hljs-keyword">double</span>&gt; <span class="hljs-title">y</span><span class="hljs-params">(status.lagrange, status.lagrange + MPC_CONTROLLER_N1)</span></span>;
        results.lagrange_multipliers = y;
        results.inner_iterations = status.num_inner_iterations;
        results.outer_iterations = status.num_outer_iterations;
        results.norm_fpr = status.last_problem_norm_fpr;
        results.penalty = status.penalty;
        results.status = (<span class="hljs-keyword">int</span>)status.exit_status;
        results.solve_time_ms = (<span class="hljs-keyword">double</span>)status.solve_time_ns / <span class="hljs-number">1000000.0</span>;
        results.infeasibility_f2 = status.f2_norm;
        results.infeasibility_f1 = status.delta_y_norm_over_c;
    }

    <span class="hljs-comment">/**
     * Callback that obtains data from topic `/open_nmpc_controller/open_params`
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">mpcReceiveRequestCallback</span><span class="hljs-params">(
        <span class="hljs-keyword">const</span> open_nmpc_controller::OptimizationParameters::ConstPtr&amp; msg)</span>
    </span>{
        params = *msg;
    }

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">solveAndPublish</span><span class="hljs-params">(ros::Publisher&amp; publisher)</span>
    </span>{
        updateInputData(); <span class="hljs-comment">/* get input data */</span>
        mpc_controllerSolverStatus status = solve(); <span class="hljs-comment">/* solve!  */</span>
        updateResults(status); <span class="hljs-comment">/* pack results into `results` */</span>
        publishToTopic(publisher);
    }
    
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">commandPoseCallback</span><span class="hljs-params">(<span class="hljs-keyword">const</span> geometry_msgs::PoseStampedConstPtr&amp; msg)</span>
    </span>{
        current_ref[<span class="hljs-number">0</span>] = msg-&gt;pose.<span class="hljs-built_in">position</span>.x;
        current_ref[<span class="hljs-number">1</span>] = msg-&gt;pose.<span class="hljs-built_in">position</span>.y;
        current_ref[<span class="hljs-number">2</span>] = msg-&gt;pose.orientation.w;
    }

    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">odometryCallback</span><span class="hljs-params">(<span class="hljs-keyword">const</span> nav_msgs::Odometry::ConstPtr &amp;msg)</span> </span>{
        <span class="hljs-keyword">double</span> roll, pitch, yaw;
        
        <span class="hljs-function">tf::Quaternion <span class="hljs-title">quat</span><span class="hljs-params">(msg-&gt;pose.pose.orientation.x,
                            msg-&gt;pose.pose.orientation.y,
                            msg-&gt;pose.pose.orientation.z,
                            msg-&gt;pose.pose.orientation.w)</span></span>;
        tf::Matrix3x3(quat).getRPY(roll, pitch, yaw);
        
        current_pos[<span class="hljs-number">0</span>] = msg-&gt;pose.pose.<span class="hljs-built_in">position</span>.x;
        current_pos[<span class="hljs-number">1</span>] = msg-&gt;pose.pose.<span class="hljs-built_in">position</span>.y;
        current_pos[<span class="hljs-number">2</span>] = yaw;
    }
    
    <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">solveAndPublishCmdVel</span><span class="hljs-params">(ros::Publisher&amp; publisher)</span>
    </span>{
        <span class="hljs-keyword">double</span> current_par [MPC_CONTROLLER_NUM_PARAMETERS] = {<span class="hljs-number">0</span>};
        <span class="hljs-keyword">double</span> current_var [MPC_CONTROLLER_NUM_DECISION_VARIABLES] = {<span class="hljs-number">0</span>};
        <span class="hljs-keyword">double</span> lin_vel_cmd, ang_vel_cmd = <span class="hljs-number">0</span>;
        
        <span class="hljs-keyword">for</span> (<span class="hljs-keyword">int</span> i=<span class="hljs-number">0</span>; i&lt;NX; i++) {
            current_par[i] = current_pos[i];
            current_par[i+NX] = current_ref[i];
        }
        
        <span class="hljs-comment">/* solve                  */</span>
        mpc_controllerSolverStatus status
            = mpc_controller_solve(cache, current_var, current_par, <span class="hljs-number">0</span>, &amp;init_penalty);
        
        lin_vel_cmd = current_var[<span class="hljs-number">0</span>];
        ang_vel_cmd = current_var[<span class="hljs-number">1</span>];
    
        geometry_msgs::Twist twist;
        twist.linear.x = lin_vel_cmd;
        twist.linear.y = <span class="hljs-number">0.0</span>;
        twist.linear.z = <span class="hljs-number">0.0</span>;
        twist.angular.x = <span class="hljs-number">0.0</span>;
        twist.angular.y = <span class="hljs-number">0.0</span>;
        twist.angular.z = ang_vel_cmd;
        publisher.publish(twist);
        
        ROS_INFO(<span class="hljs-string">"x: %f, y: %f, yaw: %f"</span>, current_pos[<span class="hljs-number">0</span>], current_pos[<span class="hljs-number">1</span>], current_pos[<span class="hljs-number">2</span>]);
        ROS_INFO(<span class="hljs-string">"Solve time: %f ms. I will send %f %f \n"</span>,
                 (<span class="hljs-keyword">double</span>)status.solve_time_ns / <span class="hljs-number">1000000.0</span>, lin_vel_cmd, ang_vel_cmd);

    }
    
}; <span class="hljs-comment">/* end of class OptimizationEngineManager */</span>

} <span class="hljs-comment">/* end of namespace open_nmpc_controller */</span>

<span class="hljs-comment">/**
 * Main method
 *
 * This advertises a new (private) topic to which the optimizer
 * announces its solution and solution status and details. The
 * publisher topic is 'open_nmpc_controller/result'.
 *
 * It obtains inputs from 'open_nmpc_controller/parameters'.
 *
 */</span>
<span class="hljs-function"><span class="hljs-keyword">int</span> <span class="hljs-title">main</span><span class="hljs-params">(<span class="hljs-keyword">int</span> argc, <span class="hljs-keyword">char</span>** argv)</span>
</span>{

    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> result_topic, params_topic;  <span class="hljs-comment">/* parameter and result topics */</span>
    <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span> out_twist, in_odometry;
    <span class="hljs-keyword">double</span> rate; <span class="hljs-comment">/* rate of node (specified by parameter) */</span>

    open_nmpc_controller::OptimizationEngineManager mng;
    ros::init(argc, argv, ROS_NODE_MPC_CONTROLLER_NODE_NAME);
    ros::NodeHandle nh, private_nh(<span class="hljs-string">"~"</span>);

    <span class="hljs-comment">/* obtain parameters from config/open_params.yaml file */</span>
    private_nh.param(<span class="hljs-string">"result_topic"</span>, result_topic,
                     <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(ROS_NODE_MPC_CONTROLLER_RESULT_TOPIC));
    private_nh.param(<span class="hljs-string">"params_topic"</span>, params_topic,
                     <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(ROS_NODE_MPC_CONTROLLER_PARAMS_TOPIC));
    private_nh.param(<span class="hljs-string">"rate"</span>, rate,
                     <span class="hljs-keyword">double</span>(ROS_NODE_MPC_CONTROLLER_RATE));
    
    private_nh.param(<span class="hljs-string">"out_twist_name"</span>, out_twist, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(<span class="hljs-string">"/husky_velocity_controller/cmd_vel"</span>));
    private_nh.param(<span class="hljs-string">"in_odom_name"</span>, in_odometry, <span class="hljs-built_in">std</span>::<span class="hljs-built_in">string</span>(<span class="hljs-string">"/odometry/filtered"</span>));

    ros::Publisher mpc_pub
        = private_nh.advertise&lt;open_nmpc_controller::OptimizationResult&gt;(
            result_topic,
            ROS_NODE_MPC_CONTROLLER_RESULT_TOPIC_QUEUE_SIZE);
    ros::Subscriber sub
        = private_nh.subscribe(
            params_topic,
            ROS_NODE_MPC_CONTROLLER_PARAMS_TOPIC_QUEUE_SIZE,
            &amp;open_nmpc_controller::OptimizationEngineManager::mpcReceiveRequestCallback,
            &amp;mng);
    ros::Subscriber pos_sub
        = nh.subscribe(in_odometry,
                       <span class="hljs-number">1</span>,
                       &amp;open_nmpc_controller::OptimizationEngineManager::odometryCallback,
                       &amp;mng);
    ros::Subscriber command_trajectory_subscriber
        = private_nh.subscribe(<span class="hljs-string">"command/pose"</span>,
                               <span class="hljs-number">1</span>,
                               &amp;open_nmpc_controller::OptimizationEngineManager::commandPoseCallback,
                               &amp;mng);
    ros::Publisher pub_twist_cmd = nh.advertise&lt;geometry_msgs::Twist&gt;(out_twist, <span class="hljs-number">1</span>);
    <span class="hljs-function">ros::Rate <span class="hljs-title">loop_rate</span><span class="hljs-params">(rate)</span></span>;

    <span class="hljs-keyword">while</span> (ros::ok()) {
        mng.solveAndPublishCmdVel(pub_twist_cmd);
        ros::spinOnce();
        loop_rate.sleep();
    }

    <span class="hljs-keyword">return</span> <span class="hljs-number">0</span>;
}
</code></pre>
<p>After that, we need to rebuild and launch our ROS package</p>
<pre><code class="hljs css language-bash"><span class="hljs-built_in">cd</span> ~/open_ros_codegen/catkin_ws/
catkin build
roslaunch open_nmpc_controller open_optimizer.launch 
</code></pre>
<p>You can command the vehicle to go to the position $x^{\mathrm{ref}} = (10, 10, 0)$ by writing on a new terminal window:</p>
<pre><code class="hljs css language-bash"><span class="hljs-built_in">source</span> ~/open_ros_codegen/catkin_ws/devel/setup.bash
rostopic pub /open_nmpc_controller/<span class="hljs-built_in">command</span>/pose geometry_msgs/PoseStamped <span class="hljs-string">"header:
  seq: 0
  stamp:
    secs: 0
    nsecs: 0
  frame_id: ''
pose:
  position:
    x: 10.0
    y: 10.0
    z: 0.0
  orientation:
    x: 0.0
    y: 0.0
    z: 0.0
    w: 0.0"</span>
</code></pre>
<p>The source code of this example is available at <a href="https://github.com/gmsanchez/open_ros_codegen">open_ros_codegen</a> Github repository.</p>
</span></div></article></div><div class="docs-prevnext"><a class="docs-prev button" href="/optimization-engine/docs/example_invpend_py"><span class="arrow-prev">← </span><span>Inverted Pendulum</span></a></div></div></div><nav class="onPageNav"><ul class="toc-headings"><li><a href="#auto-generated-ground-vehicle-navigation-for-ros">Auto-generated ground vehicle navigation for ROS</a><ul class="toc-headings"><li><a href="#code-generation-for-the-mpc-controller">Code generation for the MPC controller</a></li><li><a href="#install-opengen-050-in-a-virtual-environment">Install opengen 0.5.0 in a virtual environment</a></li><li><a href="#run-the-example-code-generation-program">Run the example code generation program</a></li></ul></li><li><a href="#create-a-ros-workspace-for-our-new-package">Create a ROS workspace for our new package</a></li><li><a href="#download-and-run-husky-packages">Download and run Husky packages</a></li><li><a href="#edit-the-auto-generated-node">Edit the auto-generated node</a></li></ul></nav></div><footer class="nav-footer" id="footer"><section class="sitemap"><a href="/optimization-engine/" class="nav-home"><img src="/optimization-engine/img/box.png" alt="OpEn" width="66" height="58"/></a><div><h5>Docs</h5><a href="/optimization-engine/docs/open-intro.html">Getting Started</a><a href="/optimization-engine/docs/python-interface.html">Python interface</a><a href="/optimization-engine/docs/matlab-interface.html">MATLAB interface</a><a href="/optimization-engine/docs/docker">Docker</a></div><div><h5>Community</h5><a href="/optimization-engine/users.html">User Showcase</a><a href="https://discord.gg/mfYpn4V" target="_blank" rel="noreferrer noopener">Discord community</a><a href="https://gitter.im/alphaville/optimization-engine" target="_blank" rel="noreferrer noopener">Chat on Gitter</a><a href="https://twitter.com/isToxic" target="_blank" rel="noreferrer noopener">Twitter</a></div><div><h5>More</h5><a href="/optimization-engine/blog">Blog</a><a href="https://github.com/alphaville/optimization-engine" target="_blank">GitHub</a><a href="https://www.openhub.net/p/optimization-engine" target="_blank">Openhub</a><a class="github-button" href="https://github.com/alphaville/optimization-engine" data-icon="octicon-star" data-count-href="/alphaville/optimization-engine/stargazers" data-show-count="true" data-count-aria-label="# stargazers on GitHub" aria-label="Star this project on GitHub">Star</a><br/><br/><a href="https://twitter.com/share?ref_src=twsrc%5Etfw&amp;via=isToxic" class="twitter-share-button" data-show-count="false" data-text="Fast and accurate embedded nonconvex optimization with #OptimizationEngine">Tweet</a><script async="" src="https://platform.twitter.com/widgets.js" charSet="utf-8"></script></div></section><section class="copyright">Copyright © 2022 Pantelis Sopasakis and Emil Fresk</section><section class="copyright"><div>Box Icon made by <a href="https://www.flaticon.com/authors/freepik" title="Freepik">Freepik</a> from <a href="https://www.flaticon.com/" title="Flaticon">www.flaticon.com</a></div></section></footer></div></body></html>